name: Docker Build and Push Image
on:
  push:
    branches: [main]
env:
  IMAGE_NAME: upi-link
  MANIFEST_REPO: git@github.com:Harsh-2002/argocd.git
  MANIFEST_PATH: k3s/arson/UPI-Link/deployment.yaml
  GIT_USER_EMAIL: "av7312002@gmail.com"
  GIT_USER_NAME: "Harsh-2002"
  TZ: "Asia/Kolkata" 
  SLACK_WEBHOOK: "https://hooks.slack.com/services/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"

jobs:
  build-and-push:
    runs-on: [self-hosted, linux, x64]
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure Git
        run: |
          git config --global user.email "${{ env.GIT_USER_EMAIL }}"
          git config --global user.name "${{ env.GIT_USER_NAME }}"

      - name: Generate IST timestamp tag
        id: timestamp
        run: |
          echo "tag=$(TZ='Asia/Kolkata' date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT
          echo "Using tag: $(TZ='Asia/Kolkata' date +'%Y%m%d-%H%M%S')"

      # Login to private registry
      - name: Log into Private Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.PRIVATE_DOCKER_REGISTRY_URL }}
          username: ${{ secrets.PRIVATE_DOCKERHUB_USERNAME }}
          password: ${{ secrets.PRIVATE_DOCKERHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.PRIVATE_DOCKER_REGISTRY_URL }}/upi-link:${{ steps.timestamp.outputs.tag }}
            ${{ secrets.PRIVATE_DOCKER_REGISTRY_URL }}/upi-link:latest

      - name: Clone and Update Manifest
        run: |
          # Ensure clean state
          rm -rf argocd || true
          
          # Clone with SSH
          git clone $MANIFEST_REPO argocd
          
          # Update manifest with new tag
          cd argocd
          sed -i "s|image: ${{ secrets.PRIVATE_DOCKER_REGISTRY_URL }}/upi-link:.*|image: ${{ secrets.PRIVATE_DOCKER_REGISTRY_URL }}/upi-link:${{ steps.timestamp.outputs.tag }}|" $MANIFEST_PATH
          
          # Commit and push changes
          git add $MANIFEST_PATH
          git commit -m "Update upi-link to IST timestamp: ${{ steps.timestamp.outputs.tag }}" || echo "No changes to commit"
          git push || echo "No changes to push"
          
      - name: Login to ArgoCD
        run: |
          argocd login argocd.srvr.site --grpc-web \
            --username ${{ secrets.ARGOCD_USERNAME }} \
            --password ${{ secrets.ARGOCD_PASSWORD }}
          
      - name: Get Last Commit Message
        id: commit
        run: |
          echo "message=$(git log -1 --pretty=%B)" >> $GITHUB_OUTPUT

      - name: ArgoCD Sync with Strategy
        id: sync
        run: |
          argocd app sync k3s \
            --force \
            --prune \
            --allow-empty \
            --retry-limit 3
          
          echo "Starting sync for application..."
          argocd app wait k3s --timeout 300

      - name: Notify Slack on Success
        if: success()
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "✅ Deployment Successful",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Image:*\n`${{ secrets.PRIVATE_DOCKER_REGISTRY_URL }}/upi-link:${{ steps.timestamp.outputs.tag }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Environment:*\nProduction"
                    }
                  ]
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Last Commit:*\n`${{ steps.commit.outputs.message }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Deployed By:*\n${{ github.actor }}"
                    }
                  ]
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "Deployment completed at: $(date)"
                    }
                  ]
                }
              ]
            }' ${{ env.SLACK_WEBHOOK }}

      - name: Notify Slack on Failure
        if: failure()
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "❌ Deployment Failed",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Image:*\n`${{ secrets.PRIVATE_DOCKER_REGISTRY_URL }}/upi-link:${{ steps.timestamp.outputs.tag }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Environment:*\nProduction"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Error:* Check GitHub Actions for details"
                  }
                }
              ]
            }' ${{ env.SLACK_WEBHOOK }}